# Assembly Lime — Software Factory POC (Bun + TypeScript, Postgres-Optimized)
*A single “source of truth” plan + minutely detailed instructions for an AI coding agent to implement with you.*

> **POC goal:** Any org (tenant) connects their **codebases** + **deployment pipelines**, then PM/Dev/QA collaborate in a **dashboard** to plan, discuss, and build with AI agents (Codex + Claude Agent SDK).  
> **Runtime choice:** Bun for web + API + Claude worker; Node 20 worker for Codex SDK.  
> **Database:** PostgreSQL (all primary keys are `int/bigint`, **no UUID**).

---

## 0) POC Scope Snapshot

### Must-have UX (based on your reference UIs)
1. **Command Center (Chat-first)**
   - Big prompt box, model/provider selector (Codex/Claude), quick action chips.
   - Streaming transcript with artifacts (diffs, PR links, test output).

2. **Kanban Board (Jira-like)**
   - Columns: `Backlog → Todo → In Progress → Code Review → QA → Done`
   - Card drag/drop, quick filters, ticket drawer details.

3. **GitHub repo + pipeline visibility**
   - Connect repo(s), show PR status and GitHub Actions workflow status.

4. **AI Agents that operate on tickets**
   - Modes: `plan`, `implement`, `bugfix`, `review`
   - Outputs: ticket plan + diffs + PRs (optional in v0), all auditable.

### POC Non-goals
- Multi-provider repo support (GitLab/Bitbucket) beyond interface stubs.
- Full enterprise governance (SCIM/SSO), complex RBAC matrices.
- Multi-CI support (only GH Actions visibility; triggers optional).

---

## 1) SDK Choices and Worker Layout

### OpenAI Codex SDK (TypeScript)
- Use the official SDK in a **Node 20** worker container to avoid runtime edge cases.
- Docs: https://developers.openai.com/codex/sdk/

### Claude Agent SDK (TypeScript)
- Run in **Bun** worker container.
- Docs: https://platform.claude.com/docs/en/agent-sdk/overview  
  Typescript: https://platform.claude.com/docs/en/agent-sdk/typescript

**Implication:** Bun is your main runtime, but Codex execution happens in a Node worker behind a queue.

---

## 2) Architecture (POC but production-shaped)

### Services
- **web**: React + Vite + Tailwind (served by Bun)
- **api**: Bun (Elysia)
- **worker-claude**: Bun + Claude Agent SDK
- **worker-codex**: Node 20 + Codex SDK
- **postgres**: Postgres 16
- **redis**: queue + pubsub

### Data flow (agent run)
1. UI requests agent run: `POST /agent-runs`
2. API creates `agent_runs` row, enqueues job in Redis (BullMQ)
3. Worker pulls job, clones repo, runs agent, emits streaming `agent_events`
4. API persists events + broadcasts them to UI via WebSocket
5. On completion: store diff, artifacts, PR link, test results

---

## 3) Monorepo Layout (agent must generate this)

```
assembly-lime/
  apps/
    web/
    api/
    worker-claude/
    worker-codex/
  packages/
    shared/
  infra/
    docker-compose.yml
    k8s/ (optional stubs)
  docs/
    drm.md
    api.md
    threat-model.md
    runbooks.md
```

---

## 4) DRM Models You Provided (must be in the plan)
Your DRM list (tenant-scoped):
- tenants
- users_roles
- users
- repositories
- connectors
- webhooks
- hooks (executable JS code)
- code_diff
- api_keys
- env_vars
- build_pipelines
- deployment_targets
- custom_instructions
- budgets_per_projects
- default_agent_instructions
- default_agent_tools

This plan **includes all** of the above with optimized Postgres tables + relations.

---

## 5) Postgres-first Data Model (int/bigint IDs + optimized constraints/indexes)

### 5.1 Conventions (REQUIRED)
- Primary keys: `BIGINT GENERATED BY DEFAULT AS IDENTITY`
  - (Use `INT` only for small enums/ordering fields; keep entity IDs `BIGINT`.)
- All times: `timestamptz`
- Use extensions where helpful:
  - `CREATE EXTENSION IF NOT EXISTS citext;` (emails)
  - `CREATE EXTENSION IF NOT EXISTS pgcrypto;` (hash/random helpers)
  - Optional later: `pg_trgm`, `uuid-ossp` NOT needed (no UUIDs)
- Multi-tenant: every row is tenant-scoped via `tenant_id` FK.
- Deletion policy:
  - Use `ON DELETE CASCADE` for tightly owned records (tickets, env vars, etc.)
  - Use soft delete flags for sensitive entities like connectors, api keys.

### 5.2 Core: tenants, users, roles
**tenants**
- `id BIGINT PK`
- `name TEXT NOT NULL`
- `slug TEXT UNIQUE NOT NULL`
- `created_at timestamptz NOT NULL DEFAULT now()`

Indexes:
- `UNIQUE(slug)`

**roles** (static rows per tenant OR global)
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `name TEXT NOT NULL` (admin, pm, dev, qa)
- `permissions_json JSONB NOT NULL DEFAULT '{}'::jsonb`
- `UNIQUE(tenant_id, name)`

**users**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `email CITEXT NOT NULL`
- `name TEXT`
- `github_user_id BIGINT NULL` (external id)
- `status SMALLINT NOT NULL DEFAULT 1` (1=active, 0=disabled)
- `created_at timestamptz NOT NULL DEFAULT now()`
- `UNIQUE(tenant_id, email)`
Indexes:
- `(tenant_id, status)`
- `(tenant_id, github_user_id)`

**user_roles** (your “users_roles”)
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `user_id BIGINT FK users ON DELETE CASCADE`
- `role_id BIGINT FK roles`
- `UNIQUE(tenant_id, user_id, role_id)`
Indexes:
- `(tenant_id, user_id)`

### 5.3 Projects + boards + tickets (Kanban)
**projects**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `name TEXT NOT NULL`
- `key TEXT NOT NULL` (e.g., "AL")
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, key)`
Indexes:
- `(tenant_id, created_at DESC)`

**boards**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects ON DELETE CASCADE`
- `name TEXT NOT NULL`
- `columns_json JSONB NOT NULL` (ordered array of column keys)
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, project_id, name)`
Indexes:
- `(tenant_id, project_id)`

**tickets**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects ON DELETE CASCADE`
- `board_id BIGINT FK boards`
- `column_key TEXT NOT NULL`
- `title TEXT NOT NULL`
- `description_md TEXT`
- `priority SMALLINT DEFAULT 2` (1=high 2=med 3=low)
- `labels_json JSONB NOT NULL DEFAULT '[]'::jsonb`
- `assignee_user_id BIGINT NULL FK users`
- `repository_id BIGINT NULL FK repositories`
- `branch TEXT NULL`
- `pr_url TEXT NULL`
- `status_meta_json JSONB NOT NULL DEFAULT '{}'::jsonb` (build status, pr status)
- `created_by BIGINT FK users`
- `created_at timestamptz DEFAULT now()`
- `updated_at timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, project_id, column_key)`
- `(tenant_id, assignee_user_id)`
- `(tenant_id, repository_id)`
- `(tenant_id, updated_at DESC)`
Optional:
- GIN on `labels_json` only if you filter heavily by labels.

### 5.4 Connectors + repositories + webhooks
**connectors** (your “connectors”)
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `provider SMALLINT NOT NULL` (1=github, 2=gitlab, 3=bitbucket)
- `external_org TEXT NULL`
- `auth_type SMALLINT NOT NULL` (1=oauth, 2=app)
- `access_token_enc BYTEA NOT NULL` (encrypted)
- `refresh_token_enc BYTEA NULL`
- `scopes_json JSONB NOT NULL DEFAULT '[]'::jsonb`
- `status SMALLINT NOT NULL DEFAULT 1` (1=active, 0=revoked)
- `created_at timestamptz DEFAULT now()`
- `revoked_at timestamptz NULL`
Indexes:
- `(tenant_id, provider, status)`
- `(tenant_id, created_at DESC)`
Notes:
- Prefer GitHub App later; for POC OAuth is okay.

**repositories**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `connector_id BIGINT FK connectors`
- `provider SMALLINT NOT NULL` (match connector)
- `external_repo_id BIGINT NULL` (e.g. GitHub repo id)
- `owner TEXT NOT NULL`
- `name TEXT NOT NULL`
- `full_name TEXT NOT NULL` (owner/name)
- `clone_url TEXT NOT NULL`
- `default_branch TEXT NOT NULL`
- `is_enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, provider, full_name)`
Indexes:
- `(tenant_id, connector_id)`
- `(tenant_id, is_enabled)`
- `(tenant_id, external_repo_id)`

**webhooks**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `connector_id BIGINT FK connectors`
- `provider SMALLINT NOT NULL`
- `external_webhook_id BIGINT NULL`
- `secret_enc BYTEA NOT NULL` (encrypted)
- `events_json JSONB NOT NULL DEFAULT '[]'::jsonb`
- `target_path TEXT NOT NULL` (e.g., /github/webhook)
- `status SMALLINT NOT NULL DEFAULT 1`
- `created_at timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, connector_id, status)`

### 5.5 Hooks (executable JS code) — your “hooks”
These are tenant-scoped snippets that run on events (careful with safety).

**hooks**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `name TEXT NOT NULL`
- `event_type TEXT NOT NULL`  
  Examples: `before_agent_run`, `after_agent_run`, `ticket_created`, `ticket_moved`, `webhook_received`, `before_deploy`, `after_deploy`
- `runtime SMALLINT NOT NULL DEFAULT 1` (1=bun, 2=node)
- `code TEXT NOT NULL` (JS/TS source; for TS store compiled JS or store TS + compile step)
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `timeout_ms INT NOT NULL DEFAULT 5000`
- `created_by BIGINT FK users`
- `created_at timestamptz DEFAULT now()`
- `updated_at timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, event_type, enabled)`
**Safety rules (REQUIRED):**
- Execute in a sandbox container, no host FS, no network unless explicitly allowed.
- Provide a limited context object (tenant_id, user_id, ticket_id, agent_run_id).
- Hooks may only return JSON outputs; failures are non-fatal but logged.

### 5.6 Code diffs (your “code_diff”)
Store diffs as artifacts from agents and optionally manual diffs.

**code_diffs**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `agent_run_id BIGINT NULL FK agent_runs ON DELETE SET NULL`
- `repository_id BIGINT FK repositories`
- `base_ref TEXT NOT NULL`
- `head_ref TEXT NOT NULL`
- `unified_diff TEXT NOT NULL`
- `summary TEXT NULL`
- `stats_json JSONB NOT NULL DEFAULT '{}'::jsonb` (files_changed, insertions, deletions)
- `created_at timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, repository_id, created_at DESC)`
- `(tenant_id, agent_run_id)`
Optimization:
- Keep diffs in `TEXT` (TOAST compression handles big values). If diffs become huge, move to object storage and store pointer.

### 5.7 API keys (your “api_keys”)
User/tenant-scoped keys for API access (automation, agents, CI).

**api_keys**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `user_id BIGINT NULL FK users`
- `name TEXT NOT NULL`
- `prefix TEXT NOT NULL` (first 8 chars for display)
- `key_hash BYTEA NOT NULL` (hash of full key; never store raw key)
- `scopes_json JSONB NOT NULL DEFAULT '[]'::jsonb`
- `status SMALLINT NOT NULL DEFAULT 1` (1=active 0=revoked)
- `last_used_at timestamptz NULL`
- `created_at timestamptz DEFAULT now()`
- `revoked_at timestamptz NULL`
Indexes:
- `(tenant_id, status)`
- `(tenant_id, prefix)` UNIQUE

### 5.8 Env vars (your “env_vars”) — model for secrets/config
Make env vars attachable to deployment targets, pipelines, hooks, or agents.

**env_var_sets**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `scope_type TEXT NOT NULL`  (project|pipeline|deployment_target|hook|agent)
- `scope_id BIGINT NOT NULL`
- `name TEXT NOT NULL`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, scope_type, scope_id, name)`
Indexes:
- `(tenant_id, scope_type, scope_id)`

**env_vars**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `set_id BIGINT FK env_var_sets ON DELETE CASCADE`
- `key TEXT NOT NULL`
- `value_enc BYTEA NOT NULL` (encrypted)
- `is_secret BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, set_id, key)`
Indexes:
- `(tenant_id, set_id)`

### 5.9 Build pipelines + deployment targets
**build_pipelines**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects ON DELETE CASCADE`
- `repository_id BIGINT FK repositories`
- `provider SMALLINT NOT NULL` (1=github_actions ...)
- `name TEXT NOT NULL`
- `config_json JSONB NOT NULL` (workflow file, triggers, etc.)
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, project_id, name)`
Indexes:
- `(tenant_id, project_id)`
- `(tenant_id, repository_id)`
- `(tenant_id, enabled)`

**pipeline_runs** (optional but recommended)
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `pipeline_id BIGINT FK build_pipelines ON DELETE CASCADE`
- `external_run_id BIGINT NULL`
- `status TEXT NOT NULL` (queued|in_progress|completed)
- `conclusion TEXT NULL` (success|failure|cancelled)
- `url TEXT NULL`
- `started_at timestamptz NULL`
- `completed_at timestamptz NULL`
Indexes:
- `(tenant_id, pipeline_id, started_at DESC)`
- `(tenant_id, status)`

**deployment_targets**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects ON DELETE CASCADE`
- `name TEXT NOT NULL` (dev/uat/preprod/prod)
- `provider TEXT NOT NULL` (k8s, ecs, ssh, etc.)
- `config_json JSONB NOT NULL`
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, project_id, name)`
Indexes:
- `(tenant_id, project_id)`
- `(tenant_id, enabled)`

### 5.10 Custom instructions (your “custom_instructions”)
Hierarchical prompt system (tenant defaults → project → repo → ticket).

**custom_instructions**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `scope_type TEXT NOT NULL` (tenant|project|repository|ticket)
- `scope_id BIGINT NOT NULL`
- `mode TEXT NOT NULL` (plan|implement|bugfix|review|any)
- `content_md TEXT NOT NULL`
- `priority INT NOT NULL DEFAULT 100` (lower = stronger)
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, scope_type, scope_id, mode, priority)`
Indexes:
- `(tenant_id, scope_type, scope_id, enabled)`
- `(tenant_id, mode)`

### 5.11 Budgets per project (your “budgets_per_projects”)
**project_budgets**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects ON DELETE CASCADE`
- `period TEXT NOT NULL` (monthly|weekly|daily)
- `limit_cents BIGINT NOT NULL`
- `soft_limit_cents BIGINT NULL`
- `currency TEXT NOT NULL DEFAULT 'USD'`
- `enforce_hard_stop BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, project_id, period)`
Indexes:
- `(tenant_id, project_id)`

### 5.12 Default agent instructions + tools (your “default_*”)
Store defaults that the agent always loads.

**default_agent_instructions**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `provider TEXT NOT NULL` (codex|claude|any)
- `content_md TEXT NOT NULL`
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, provider)`
Indexes:
- `(tenant_id, enabled)`

**default_agent_tools**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `provider TEXT NOT NULL` (codex|claude|any)
- `allowed_tools_json JSONB NOT NULL` (e.g., ["read","edit","bash","grep"])
- `enabled BOOLEAN NOT NULL DEFAULT TRUE`
- `created_at timestamptz DEFAULT now()`
- `UNIQUE(tenant_id, provider)`
Indexes:
- `(tenant_id, enabled)`

### 5.13 Agent runs + events (log-heavy, PG optimized)
**agent_runs**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `project_id BIGINT FK projects`
- `ticket_id BIGINT NULL FK tickets`
- `provider TEXT NOT NULL` (codex|claude)
- `mode TEXT NOT NULL` (plan|implement|bugfix|review)
- `status TEXT NOT NULL` (queued|running|succeeded|failed|cancelled)
- `input_prompt TEXT NOT NULL`
- `output_summary TEXT NULL`
- `artifacts_json JSONB NOT NULL DEFAULT '{}'::jsonb`
- `cost_cents BIGINT NOT NULL DEFAULT 0`
- `started_at timestamptz NULL`
- `ended_at timestamptz NULL`
- `created_at timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, project_id, created_at DESC)`
- `(tenant_id, status)`
- `(tenant_id, provider, mode)`

**agent_events**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `agent_run_id BIGINT FK agent_runs ON DELETE CASCADE`
- `ts timestamptz NOT NULL DEFAULT now()`
- `type TEXT NOT NULL` (message|tool|diff|log|error|artifact)
- `payload_json JSONB NOT NULL`
Indexes:
- `(tenant_id, agent_run_id, ts)`
Scaling note:
- If events get huge, partition by month on `ts` (later milestone).

**audit_log**
- `id BIGINT PK`
- `tenant_id BIGINT FK tenants`
- `actor_user_id BIGINT FK users`
- `action TEXT NOT NULL`
- `target_type TEXT NOT NULL`
- `target_id BIGINT NOT NULL`
- `payload_json JSONB NOT NULL DEFAULT '{}'::jsonb`
- `ts timestamptz DEFAULT now()`
Indexes:
- `(tenant_id, ts DESC)`
- `(tenant_id, actor_user_id, ts DESC)`

---

## 6) Provider Abstraction (API/Workers must implement this)

**Shared protocol types** in `packages/shared/src/protocol.ts`:

```ts
export type AgentProviderId = "codex" | "claude";
export type AgentMode = "plan" | "implement" | "bugfix" | "review";

export type AgentRunRequest = {
  runId: string;             // maps to agent_runs.id
  tenantId: string;          // cast/serialize bigint carefully in TS
  projectId?: string;
  ticketId?: string;
  mode: AgentMode;
  prompt: string;
  repo?: {
    repositoryId: string;
    cloneUrl: string;
    defaultBranch: string;
    ref?: string;            // branch/sha
    allowedPaths?: string[];
  };
  constraints?: {
    timeBudgetSec?: number;
    maxCostCents?: number;
    allowedTools?: string[]; // used for Claude
  };
};

export type AgentEvent =
  | { type: "message"; role: "system"|"assistant"|"tool"; text: string }
  | { type: "log"; text: string }
  | { type: "diff"; unifiedDiff: string; summary?: string }
  | { type: "artifact"; name: string; url?: string; mime?: string }
  | { type: "error"; message: string; stack?: string };
```

**Important:** In JS/TS, bigint cannot be JSON-serialized by default. Use **string** IDs in API/WS payloads.

---

## 7) More plans required (you asked “any more plans?”)
Add these docs under `docs/` and treat them as build inputs:

1. **docs/threat-model.md**
   - agent sandbox escape risks, webhook spoofing, token leakage
2. **docs/secret-management.md**
   - encryption approach, key rotation, token storage policy
3. **docs/hook-sandboxing.md**
   - how “hooks” run safely (resource limits, no network by default)
4. **docs/budget-enforcement.md**
   - how budgets apply per project/provider/mode (soft vs hard stops)
5. **docs/data-retention.md**
   - retention for agent_events/diffs/transcripts, export rules
6. **docs/runbooks.md**
   - restart workers, purge jobs, rotate tokens, handle stuck runs

POC can ship without all the above fully implemented, but **the coding agent must create the docs stubs**.

---

## 8) API Routes (expanded to cover DRM entities)

### Auth
- `GET /auth/github/start`
- `GET /auth/github/callback`
- `POST /auth/logout`
- `GET /me`

### Tenants / Users / Roles
- `GET /tenants`
- `POST /tenants`
- `GET /users?tenantId=...`
- `POST /users`
- `GET /roles`
- `POST /users/:id/roles`

### Projects / Boards / Tickets
- `GET /projects`
- `POST /projects`
- `GET /projects/:projectId/board`
- `POST /projects/:projectId/tickets`
- `PATCH /tickets/:ticketId` (move/edit)
- `GET /tickets/:ticketId`

### Repos / Connectors / Webhooks
- `GET /connectors`
- `POST /connectors/github/oauth` (create)
- `GET /repositories`
- `POST /projects/:projectId/repositories` (attach)
- `POST /github/webhook` (receiver)
- `POST /webhooks/replay` (optional debugging)

### Hooks
- `GET /hooks`
- `POST /hooks`
- `PATCH /hooks/:id`
- `POST /hooks/:id/test` (runs sandbox w/ sample payload)

### Env Vars / Pipelines / Deployment
- `GET /env-var-sets`
- `POST /env-var-sets`
- `POST /env-var-sets/:id/vars`
- `GET /build-pipelines`
- `POST /build-pipelines`
- `GET /deployment-targets`
- `POST /deployment-targets`

### Instructions / Tools / Budgets
- `GET /custom-instructions`
- `POST /custom-instructions`
- `GET /default-agent-instructions`
- `POST /default-agent-instructions`
- `GET /default-agent-tools`
- `POST /default-agent-tools`
- `GET /project-budgets`
- `POST /project-budgets`

### Agents
- `POST /agent-runs`
- `GET /agent-runs/:id`
- `POST /agent-runs/:id/cancel`
- WebSocket: `/ws` subscribe to `run:<id>` and `board:<projectId>`

---

## 9) UI Updates Required to Support New DRM Models
Add sidebar sections:
- Repos
- Pipelines
- Deploy Targets
- Env Vars
- Hooks
- Instructions
- Budgets
- API Keys
- Audit Log

Each section gets:
- list view + create/edit modal
- at least one “test” affordance for dangerous things (hooks, webhooks)

---

## 10) Implementation Sequence (updated)

### Milestone A — Postgres schema + migrations (first)
**Goal:** implement the DRM schema above with Drizzle migrations.

Acceptance:
- `bun db:migrate` creates all tables and indexes.
- Seed roles: admin/pm/dev/qa.

### Milestone B — Auth + tenant bootstrap
- GitHub OAuth sign-in
- Auto-create tenant on first login
- Assign admin role

### Milestone C — Board CRUD + realtime
- ticket CRUD + drag/drop
- WS board broadcasting

### Milestone D — Repos/connectors + webhooks
- connect repo(s), store connectors+repos
- webhook receiver updates tickets

### Milestone E — Agent runs + events + code diffs
- queue orchestration
- store diffs in `code_diffs`
- budget enforcement (at least hard limit per project)

### Milestone F — Hooks + custom instructions
- instruction resolution engine (tenant→project→repo→ticket)
- hook sandbox runner (v0: local container execution)

---

## 11) Agent Instructions (copy/paste)

### Prime directive
- Never write secrets into DB unencrypted.
- Never execute user hooks outside sandbox.
- All bigint IDs are **strings over the wire**.

### Instruction resolution order
1. `default_agent_instructions` (tenant + provider)
2. `custom_instructions` for tenant scope
3. `custom_instructions` for project scope
4. `custom_instructions` for repository scope
5. `custom_instructions` for ticket scope
6. user prompt

### Tools allowlist
- For Claude, apply `default_agent_tools` and per-run `allowedTools`.
- For Codex, simulate allowlist via sandbox container policies.

### Required outputs per run
- At least 1 status message
- On success: diff artifact (`code_diffs`) or “no change” summary
- On failure: error event with stack trace (server-side only)

---

## 12) Infra Base (local → production)

### Local (docker-compose)
- postgres
- redis
- api (bun)
- web (bun)
- worker-claude (bun)
- worker-codex (node)

### Production-ready shape (single VM)
- reverse proxy: Caddy/Nginx
- run workers as containers
- managed Postgres/Redis when needed

---

## Appendix: Env Vars (required)
- `DATABASE_URL`
- `REDIS_URL`
- `GITHUB_CLIENT_ID`
- `GITHUB_CLIENT_SECRET`
- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY`
- `ENCRYPTION_MASTER_KEY`

---

## Next question (so we implement correctly)
Do you want **one Postgres schema shared by all tenants** (tenant_id in every table, as above), or **separate Postgres schemas per tenant**?
