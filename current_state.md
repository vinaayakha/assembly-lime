# Assembly Lime — Current State

**Last updated:** 2026-02-10
**Latest commit:** `2155a15` — K8s agent workspaces with git pipeline

---

## Architecture Overview

Multi-tenant software factory dashboard where PM/Dev/QA collaborate on planning and execution with AI agents (Claude + Codex), connected to an org's GitHub repositories and K8s deployment pipelines.

**Runtime:** Bun (API, workers) / Node 24 (web/Vite)
**Stack:** Elysia, React 19, Vite 7, Tailwind 4, PostgreSQL 16, Redis 7, Drizzle ORM, BullMQ, @dnd-kit, Radix UI

**Ports:** API `:3434` | Web `:5173` (proxies `/api` → API)

---

## Monorepo Structure

```
assemblyLime/
  apps/
    api/                  # Bun + Elysia API server
    web/                  # React + Vite frontend
    worker-claude/        # Bun + Claude Agent SDK worker
    worker-codex/         # Bun + OpenAI Codex worker
  packages/
    shared/               # Types, DB schema, prompts, protocol
  infra/
    docker-compose.yml    # Postgres 16, Redis 7, MinIO
    k8s/                  # K8s templates (RBAC, Jobs, Previews)
  docs/                   # Placeholder stubs
```

---

## Database Schema (38 tables)

All tables use `BIGINT GENERATED BY DEFAULT AS IDENTITY` PKs, `timestamptz` timestamps, and are tenant-scoped via `tenant_id` FK.

### Core
| Table | Purpose |
|-------|---------|
| `tenants` | Multi-tenant root (id, name, slug) |
| `roles` | Role definitions |
| `users` | Users with GitHub OAuth fields |
| `user_roles` | User-role assignments |

### Projects & Tickets
| Table | Purpose |
|-------|---------|
| `projects` | Projects (name, key) |
| `boards` | Kanban boards with columnsJson |
| `tickets` | Tickets (title, description, status, column, priority, assignedTo) |

### Connectors & Repos
| Table | Purpose |
|-------|---------|
| `connectors` | GitHub connectors (encrypted tokens) |
| `repositories` | Imported repos (owner, name, cloneUrl, defaultBranch) |
| `webhooks` | GitHub webhook registrations |
| `project_repositories` | Project-repo mapping with roles (primary, uatBranch, prodBranch) |
| `repository_aliases` | Repo name aliases |
| `repository_configs` | Detected config files (package.json, etc.) |

### Features (v3 — Multi-Repo)
| Table | Purpose |
|-------|---------|
| `features` | Feature definitions with search_text |
| `feature_repository_map` | Feature-to-repo mapping with relativeImpact |
| `feature_aliases` | Feature name aliases |

### Agent System
| Table | Purpose |
|-------|---------|
| `agent_runs` | Agent run records (provider, mode, status, prompts, cost, parentRunId, orchestrationMode) |
| `agent_events` | Streaming events (message, log, diff, artifact, error, status) |
| `agent_run_repos` | Run-to-repo associations |
| `code_diffs` | Stored unified diffs per file |
| `images` | S3-stored images for agent context |

### Instructions & Hooks
| Table | Purpose |
|-------|---------|
| `default_agent_instructions` | Per-tenant, per-provider defaults |
| `custom_instructions` | Scoped instructions (tenant/project/repo/ticket) |
| `default_agent_tools` | Tool allowlists per provider |
| `tool_definitions` | Custom tool definitions with schemas |
| `hooks` | Event hooks (schema only, no runtime yet) |

### Infrastructure
| Table | Purpose |
|-------|---------|
| `k8s_clusters` | Registered K8s clusters (encrypted kubeconfig) |
| `sandboxes` | Ephemeral dev environments |
| `sandbox_logs` | Pod log capture |
| `preview_deployments` | Preview environments (Deployment + Service + Ingress) |
| `domains` | Custom domain mappings |
| `build_pipelines` | CI/CD pipeline definitions |
| `pipeline_runs` | Pipeline execution records |
| `deployment_targets` | Deployment target definitions |
| `deployments` | Deployment records |
| `deployment_steps` | Deployment step tracking |

### Security & Config
| Table | Purpose |
|-------|---------|
| `api_keys` | API key hashes with scopes |
| `env_var_sets` | Environment variable groups |
| `env_vars` | Encrypted env vars |
| `project_budgets` | Per-project cost budgets |
| `audit_log` | Audit trail |

---

## API Routes (15 route files)

| Prefix | File | Endpoints |
|--------|------|-----------|
| `/auth` | auth.ts | GET /github, GET /github/callback, POST /logout |
| `/me` | me.ts | GET / |
| `/projects` | projects.ts | GET /, POST /, GET /:id, GET /:id/board, POST /:id/tickets |
| `/projects/:id/repositories` | project-repos.ts | GET /, POST /, PATCH /:repoId, DELETE /:repoId |
| `/tickets` | tickets.ts | GET /:id, PATCH /:id |
| `/agent-runs` | agent-runs.ts | POST / (K8s or BullMQ dispatch), GET /:id, GET /:id/events |
| `/images` | images.ts | POST /upload, GET /:id, DELETE /:id |
| `/preview-deployments` | preview-deployments.ts | POST /, GET /, POST /:id/destroy |
| `/connectors` | connectors.ts | POST /, GET /, GET /:id, POST /:id/revoke, GET /:id/repos, POST /:id/import |
| `/repositories` | repositories.ts | GET /, GET /:id, GET /:id/file-tree, GET /:id/file, GET /:id/configs, POST /:id/scan-configs, POST /:id/setup-webhook |
| `/sandboxes` | sandboxes.ts | POST /, GET /, GET /:id, POST /:id/destroy, GET /:id/logs |
| `/k8s-clusters` | k8s-clusters.ts | POST /, GET /, GET /:id, POST /:id/sync, DELETE /:id |
| `/domains` | domains.ts | POST /, GET /, DELETE /:id |
| `/tool-definitions` | tool-definitions.ts | POST /, GET /, GET /:id, PATCH /:id, DELETE /:id |
| `/ws` | ws.ts | WS /agent-runs/:runId (real-time event streaming) |

---

## Services (19 files)

| Service | Purpose |
|---------|---------|
| `agent-run.service` | Create runs, resolve instructions, conditional K8s vs BullMQ dispatch |
| `auth.service` | GitHub OAuth user find/create, tenant bootstrap |
| `compaction.service` | Context compaction for long agent conversations |
| `connector.service` | CRUD connectors, encrypt/decrypt tokens, K8s secret cleanup on revoke |
| `domain.service` | Custom domain + Ingress management |
| `env-detection.service` | Scan repos for config files |
| `event-subscriber` | Redis pub/sub → persist events → broadcast to WebSocket |
| `github.service` | GitHub API client (list repos, browse files, import) |
| `image.service` | S3/MinIO image upload/download |
| `instruction-resolver` | Resolve instruction layers (tenant → project → repo → ticket) |
| `k8s-cluster.service` | Register clusters, sync, delete (with namespace provisioning) |
| `k8s-job-launcher.service` | Create K8s Jobs with init-container (git clone) + agent container |
| `multi-repo.service` | Resolve repos for multi-repo runs via feature map |
| `namespace-provisioner.service` | Per-tenant namespace lifecycle (SA, Role, RoleBinding, Quota, Secrets) |
| `orchestrator.service` | Parent runs, fan-out sub-runs (parallel/sequential) |
| `preview-deploy.service` | Deploy preview environments to K8s |
| `project.service` | CRUD projects, boards, tickets |
| `sandbox.service` | Create/destroy sandbox pods, fetch logs |
| `tool-definition.service` | CRUD custom tool definitions |

---

## Frontend Pages (11 pages)

| Page | Route | Features |
|------|-------|----------|
| LoginPage | `/login` | GitHub OAuth login |
| CommandCenterPage | `/` | Chat-first agent interface, model selector, streaming transcript, artifact viewer |
| BoardPage | `/board` | Kanban board with drag/drop, ticket drawers |
| AgentRunsPage | `/agent-runs` | Agent run list |
| RunDetailPage | `/agent-runs/:id` | Run detail with streaming transcript |
| ReposPage | `/repos` | Repository listing |
| RepoDetailPage | `/repos/:id` | File tree browser, config detection |
| ConnectorsPage | `/connectors` | GitHub connector management, repo import |
| ClustersPage | `/clusters` | K8s cluster management |
| SandboxesPage | `/sandboxes` | Sandbox environment management |
| DomainsPage | `/domains` | Custom domain management |

### Key Components
- **command-center/** — EventCard, PromptPanel, TranscriptPanel
- **kanban/** — KanbanCard, KanbanColumn, TicketDrawer
- **layout/** — AppLayout, Sidebar, TopBar
- **repos/** — BranchSelector, ConfigDetection, FileTree
- **sandboxes/** — LogViewer, SandboxCard
- **ui/** — Badge, DiffViewer, EmptyState, StatusDot

### Hooks
- `useAgentRunStream` — WebSocket streaming for agent events
- `useAuth` — Authentication state management
- `useKanbanState` — Kanban board state with drag/drop
- `useRecentRuns` — Recent agent runs fetcher

---

## Worker Architecture

### worker-claude (Bun)
Two execution modes:
1. **BullMQ mode** — Polls `agent-runs-claude` queue, processes jobs directly or delegates to K8s
2. **K8s Job mode** — Runs as ephemeral K8s Job with `AGENT_JOB_PAYLOAD` env var

Agent runners:
- `claude-runner.ts` — Core Claude API streaming, diff extraction from markdown
- `multi-repo-runner.ts` — Iterates repos, delegates to claude-runner per repo
- `workspace-runner.ts` — Git-integrated: Claude call → extract file changes → apply → commit → push → create PR

Git pipeline (`src/git/`):
- `git-operations.ts` — Git CLI wrapper (clone, branch, commit, push, diff)
- `change-extractor.ts` — Parse Claude XML/fenced output → FileChange[]
- `pr-creator.ts` — GitHub REST API PR creation with run metadata

Support:
- `event-emitter.ts` — Redis pub/sub event publisher
- `compaction.ts` — Context window management

### worker-codex (Bun)
Same dual-mode architecture (BullMQ + K8s Job), with `codex-runner.ts` using OpenAI SDK.

---

## K8s Agent Workspaces (Latest Feature)

Per-tenant isolated workspaces for agent runs with full git pipeline.

### Flow
1. `POST /agent-runs` with `clusterId` + `repo` (connectorId, owner, name)
2. API decrypts connector token, ensures `git-cred-{connectorId}` K8s Secret in `al-{tenantSlug}` namespace
3. API creates K8s Job directly (bypasses BullMQ — avoids passing kubeconfigs through Redis)
4. **Init-container** (`alpine/git:2.43`): shallow clone → checkout feature branch `al/{mode}/{runId}`
5. **Main container** (agent image): runs workspace-runner with `/workspace` mount
6. Claude generates file changes (XML format) → applied to workspace → committed → pushed → PR created
7. Events stream via Redis pub/sub → API persists + broadcasts to UI

### Namespace Provisioning
On cluster registration, automatically provisions:
- Namespace `al-{tenantSlug}` with assembly-lime labels
- ServiceAccount `al-agent-sa`
- Role `al-agent-role` (pods/logs read, jobs CRUD, secrets read-only)
- RoleBinding `al-agent-binding`
- ResourceQuota (default: 8 CPU, 16Gi mem, 20 pods)

On cluster deletion: tears down entire namespace (cascading).
On connector revoke: deletes git credential Secrets across all tenant clusters.

---

## Shared Package (packages/shared)

### Protocol Types
- `AgentProviderId` — `"codex" | "claude"`
- `AgentMode` — `"plan" | "implement" | "bugfix" | "review"`
- `AgentRunStatus` — `"queued" | "running" | "completed" | "failed" | "cancelled"`
- `AgentJobPayload` — Full job payload with repo (connectorId, owner, name), constraints, k8s config, images
- `AgentEvent` — Union: message | log | diff | artifact | error | status | preview | compaction
- Queue constants + Redis channel helpers

### Prompt Resolution
- `PROVIDER_PREAMBLES` — Claude/Codex system prompts
- `MODE_PROMPTS` — Plan/Implement/Bugfix/Review mode instructions
- `resolvePrompt()` — Combines: preamble + mode + instruction layers + user prompt
- Instruction layer order: default_agent_instructions → custom_instructions (tenant → project → repo → ticket) → user prompt

---

## Infrastructure

### docker-compose.yml
- PostgreSQL 16 (port 5432)
- Redis 7 (port 6379)
- MinIO (ports 9000/9001) — S3-compatible image storage

### K8s Templates (infra/k8s/)
- `namespace.yaml` — Base namespace
- `rbac.yaml` — Per-tenant RBAC template (al-agent-sa, al-agent-role, quota)
- `agent-job-template.yaml` — Reference Job template
- `preview-deployment-template.yaml` — Preview Deployment template
- `preview-ingress-template.yaml` — Preview Ingress template

---

## Feature Completeness

### Fully Implemented
- GitHub OAuth + session-based auth
- Tenant auto-bootstrap on first login
- Projects, boards, tickets CRUD with Kanban drag/drop
- GitHub connectors (OAuth tokens, import repos, webhooks)
- Repository browsing (file tree, file content via GitHub API)
- Project-repo mapping with roles
- Agent runs with streaming events (WebSocket)
- Claude + Codex workers (BullMQ + K8s Job modes)
- Instruction resolution hierarchy (6 layers)
- Multi-repo orchestration (feature map + parallel/sequential fan-out)
- K8s cluster management with per-tenant namespace provisioning
- K8s agent workspaces with git clone → branch → commit → push → PR pipeline
- Preview deployments (K8s Deployment + Service + Ingress)
- Sandboxes (ephemeral dev environments)
- Custom domains
- Image uploads (S3/MinIO)
- Context compaction for long agent conversations
- Config detection (scan repos for package.json, etc.)
- Custom tool definitions registry
- Structured pino logging with request IDs + run IDs
- Connector revocation with K8s secret cleanup

### Schema Defined, Not Yet Implemented
- **Roles & Permissions** — Schema exists, no middleware enforcement
- **API Keys** — Schema defined, no generation or validation
- **Hooks** — Schema defined, no sandbox execution runtime
- **Budgets** — Schema defined, no enforcement logic
- **CI/CD Pipelines** — Schema defined, no integration
- **Deployment Targets/Steps** — Schema defined, no orchestration
- **Env Var Sets** — Schema defined, no injection into agents
- **Feature Aliases** — Schema defined, no search implementation
- **Audit Log** — Schema defined, not actively written

### Not Started
- Documentation (all docs/*.md are stubs)
- Role-based access control enforcement
- Budget enforcement / cost tracking
- Hook sandbox execution
- Pipeline integration (GitHub Actions visibility)
